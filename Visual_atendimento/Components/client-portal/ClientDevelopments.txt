import React, { useState } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Textarea } from "@/components/ui/textarea";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Checkbox } from "@/components/ui/checkbox";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
} from "@/components/ui/dialog";
import { 
  FileText, 
  Clock, 
  CheckCircle2, 
  XCircle,
  Eye,
  MessageSquare,
  Package,
  Calendar,
  Loader2,
  Download,
  Image,
  History,
  ShoppingCart,
  Palette,
  Settings,
  ZoomIn,
  X,
  MapPin,
  CreditCard,
  Plus,
  Search
} from "lucide-react";
import { format } from "date-fns";
import { ptBR } from "date-fns/locale";

const statusConfig = {
  pending: { label: 'Pendente', color: 'bg-amber-100 text-amber-700', icon: Clock },
  in_development: { label: 'Em Desenvolvimento', color: 'bg-blue-100 text-blue-700', icon: Package },
  awaiting_approval: { label: 'Aguardando Aprovação', color: 'bg-violet-100 text-violet-700', icon: Eye },
  revision_requested: { label: 'Revisão Solicitada', color: 'bg-orange-100 text-orange-700', icon: MessageSquare },
  approved: { label: 'Aprovado', color: 'bg-emerald-100 text-emerald-700', icon: CheckCircle2 },
  order_created: { label: 'Pedido Emitido', color: 'bg-cyan-100 text-cyan-700', icon: ShoppingCart },
  production: { label: 'Em Produção', color: 'bg-cyan-100 text-cyan-700', icon: Package },
  completed: { label: 'Concluído', color: 'bg-green-100 text-green-700', icon: CheckCircle2 },
  cancelled: { label: 'Cancelado', color: 'bg-red-100 text-red-700', icon: XCircle }
};

export default function ClientDevelopments({ developments, customerId, customerData, allArtworkVersions: externalArtworks }) {
  const queryClient = useQueryClient();
  const [selectedDev, setSelectedDev] = useState(null);
  const [showDetailModal, setShowDetailModal] = useState(false);
  const [showApprovalModal, setShowApprovalModal] = useState(false);
  const [showOrderModal, setShowOrderModal] = useState(false);
  const [revisionNotes, setRevisionNotes] = useState('');
  const [actionType, setActionType] = useState(null);
  const [confirmApproval, setConfirmApproval] = useState(false);
  const [selectedForOrder, setSelectedForOrder] = useState([]);
  const [activeTab, setActiveTab] = useState('all');
  const [zoomedImage, setZoomedImage] = useState(null);
  const [paymentMethod, setPaymentMethod] = useState('pix');
  const [addressType, setAddressType] = useState('customer');
  const [customAddress, setCustomAddress] = useState({
    street: '',
    number: '',
    complement: '',
    neighborhood: '',
    city: '',
    state: '',
    zipcode: ''
  });
  const [approvedSearch, setApprovedSearch] = useState('');

  // Use external artworks or load locally
  const allArtworkVersions = externalArtworks || [];

  // Load artwork versions for selected development
  const { data: artworkVersions = [] } = useQuery({
    queryKey: ['artwork-versions', selectedDev?.id],
    queryFn: () => base44.entities.ArtworkVersion.filter(
      { development_id: selectedDev.id },
      '-version_number'
    ),
    enabled: !!selectedDev?.id
  });

  // Get latest artwork image for a development
  const getLatestArtwork = (devId) => {
    const version = allArtworkVersions.find(v => v.development_id === devId);
    return version?.file_url || null;
  };

  // Update development
  const updateDev = useMutation({
    mutationFn: async ({ id, data }) => {
      return base44.entities.DevelopmentRequest.update(id, data);
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['client-developments']);
      setShowApprovalModal(false);
      setRevisionNotes('');
      setConfirmApproval(false);
    }
  });

  // Create order from approved developments
  const createOrder = useMutation({
    mutationFn: async ({ devIds, payment, address }) => {
      const selectedDevs = developments.filter(d => devIds.includes(d.id));
      const orderNumber = `PED-${Date.now().toString(36).toUpperCase()}`;
      
      // Get latest artwork for each dev
      const items = await Promise.all(selectedDevs.map(async (dev) => {
        // Get the latest artwork version for this development
        let imageUrl = dev.main_image;
        try {
          const artworks = await base44.entities.ArtworkVersion.filter(
            { development_id: dev.id },
            '-version_number',
            1
          );
          if (artworks.length > 0) {
            imageUrl = artworks[0].file_url;
          }
        } catch (e) {}
        
        return {
          product_id: dev.product_id,
          product_name: dev.product_name,
          development_id: dev.id,
          reference_code: dev.request_number,
          image_url: imageUrl,
          quantity: dev.quantity,
          unit_price: dev.unit_price || 0,
          total: (dev.unit_price || 0) * dev.quantity
        };
      }));

      const total = items.reduce((sum, item) => sum + item.total, 0);

      // Create order
      const order = await base44.entities.Order.create({
        order_number: orderNumber,
        customer_id: customerId,
        customer_name: selectedDevs[0].customer_name,
        customer_email: selectedDevs[0].customer_email,
        items,
        subtotal: total,
        total,
        status: 'pending',
        payment_status: 'pending',
        payment_method: payment,
        shipping_address: address,
        notes: `Pedido gerado a partir de ${selectedDevs.length} desenvolvimento(s) aprovado(s)`
      });

      return order;
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['client-developments']);
      queryClient.invalidateQueries(['client-orders']);
      setShowOrderModal(false);
      setSelectedForOrder([]);
      setPaymentMethod('pix');
      setAddressType('customer');
      setCustomAddress({ street: '', number: '', complement: '', neighborhood: '', city: '', state: '', zipcode: '' });
    }
  });

  const handleOpenDetail = (dev) => {
    setSelectedDev(dev);
    setShowDetailModal(true);
  };

  const handleOpenApproval = (dev, type) => {
    setSelectedDev(dev);
    setActionType(type);
    setRevisionNotes('');
    setConfirmApproval(false);
    setShowApprovalModal(true);
  };

  const handleApprove = async () => {
    let clientIP = 'unknown';
    try {
      const ipResponse = await fetch('https://api.ipify.org?format=json');
      const ipData = await ipResponse.json();
      clientIP = ipData.ip;
    } catch (e) {}

    updateDev.mutate({
      id: selectedDev.id,
      data: {
        status: 'approved',
        approved_at: new Date().toISOString(),
        approved_ip: clientIP
      }
    });

    await base44.entities.ActivityLog.create({
      user_email: selectedDev.customer_email || 'cliente',
      user_name: selectedDev.customer_name,
      action_type: 'approve',
      entity_type: 'development',
      entity_id: selectedDev.id,
      entity_name: selectedDev.request_number,
      description: `Cliente aprovou o desenvolvimento`,
      ip_address: clientIP
    });
  };

  const handleRequestRevision = () => {
    updateDev.mutate({
      id: selectedDev.id,
      data: {
        status: 'revision_requested',
        revision_notes: revisionNotes,
        estimated_delivery_date: null // Limpa a data para o designer definir nova
      }
    });
  };

  const toggleSelectForOrder = (devId) => {
    setSelectedForOrder(prev => 
      prev.includes(devId) 
        ? prev.filter(id => id !== devId)
        : [...prev, devId]
    );
  };

  const awaitingApproval = developments.filter(d => d.status === 'awaiting_approval');
  const approvedDevelopments = developments.filter(d => d.status === 'approved' || d.status === 'order_created' || d.status === 'production' || d.status === 'completed');
  const otherDevelopments = developments.filter(d => 
    !['awaiting_approval', 'approved'].includes(d.status)
  );

  const renderDevelopmentCard = (dev, showActions = false, showCheckbox = false, useLatestArtwork = false) => {
    const StatusIcon = statusConfig[dev.status]?.icon || Clock;
    const displayImage = useLatestArtwork ? (getLatestArtwork(dev.id) || dev.main_image) : dev.main_image;
    return (
      <Card 
        key={dev.id} 
        className={`border-0 shadow-sm hover:shadow-md transition-shadow cursor-pointer ${
          showCheckbox && selectedForOrder.includes(dev.id) ? 'ring-2 ring-violet-500' : ''
        }`}
        onClick={() => showCheckbox ? toggleSelectForOrder(dev.id) : handleOpenDetail(dev)}
      >
        <CardContent className="p-4">
          <div className="flex items-start gap-4">
            {showCheckbox && (
              <Checkbox 
                checked={selectedForOrder.includes(dev.id)}
                className="mt-1"
              />
            )}
            <div className="w-16 h-16 rounded-lg bg-slate-100 overflow-hidden flex-shrink-0">
              {displayImage ? (
                <img src={displayImage} alt="" className="w-full h-full object-cover" />
              ) : (
                <div className="w-full h-full flex items-center justify-center">
                  <Package className="w-6 h-6 text-slate-300" />
                </div>
              )}
            </div>
            
            <div className="flex-1 min-w-0">
              <div className="flex items-center gap-2 mb-1">
                  <span className="font-medium text-slate-900">{dev.product_name}</span>
                  <Badge variant="outline" className="text-xs font-mono">
                    {dev.reference_code || dev.request_number}
                  </Badge>
                </div>
              <div className="flex items-center gap-4 text-sm text-slate-500">
                <span>{dev.quantity} un.</span>
                {dev.unit_price && <span>R$ {dev.unit_price.toFixed(2)}/un</span>}
                {dev.estimated_delivery_date && (
                  <span className="flex items-center gap-1">
                    <Calendar className="w-3 h-3" />
                    Prev: {format(new Date(dev.estimated_delivery_date), "dd/MM")}
                  </span>
                )}
              </div>
              
              {/* Show selected processes and materials */}
              <div className="flex flex-wrap gap-1 mt-2">
                {dev.selected_processes?.slice(0, 2).map((p, idx) => (
                  <Badge key={idx} variant="outline" className="text-xs bg-violet-50">
                    <Settings className="w-3 h-3 mr-1" />
                    {p.process_name}
                  </Badge>
                ))}
                {dev.selected_materials?.slice(0, 2).map((m, idx) => (
                  <Badge key={idx} variant="outline" className="text-xs bg-amber-50">
                    <Palette className="w-3 h-3 mr-1" />
                    {m.display_name}: {m.selected_color}
                  </Badge>
                ))}
              </div>
            </div>

            <div className="flex flex-col items-end gap-2">
              <Badge className={statusConfig[dev.status]?.color}>
                {statusConfig[dev.status]?.label}
              </Badge>
              {dev.total_price && (
                <span className="font-bold text-slate-900">
                  R$ {dev.total_price.toFixed(2)}
                </span>
              )}
            </div>
          </div>

          {showActions && dev.status === 'awaiting_approval' && (
            <div className="flex gap-2 mt-4 pt-4 border-t">
              <Button 
                variant="outline"
                size="sm"
                className="flex-1"
                onClick={(e) => {
                  e.stopPropagation();
                  handleOpenApproval(dev, 'revision');
                }}
              >
                <MessageSquare className="w-4 h-4 mr-1" />
                Revisão
              </Button>
              <Button 
                size="sm"
                className="flex-1 bg-emerald-600 hover:bg-emerald-700"
                onClick={(e) => {
                  e.stopPropagation();
                  handleOpenApproval(dev, 'approve');
                }}
              >
                <CheckCircle2 className="w-4 h-4 mr-1" />
                Aprovar
              </Button>
            </div>
          )}
        </CardContent>
      </Card>
    );
  };

  return (
    <div className="space-y-6">
      <Tabs value={activeTab} onValueChange={setActiveTab}>
        <TabsList className="grid grid-cols-3 w-full max-w-md">
          <TabsTrigger value="all">
            Todos
            <Badge variant="outline" className="ml-2">{developments.length}</Badge>
          </TabsTrigger>
          <TabsTrigger value="pending">
            Aguardando
            <Badge variant="outline" className="ml-2">{awaitingApproval.length}</Badge>
          </TabsTrigger>
          <TabsTrigger value="approved">
            Aprovados
            <Badge variant="outline" className="ml-2">{approvedDevelopments.length}</Badge>
          </TabsTrigger>
        </TabsList>

        <TabsContent value="all" className="mt-6 space-y-4">
          {developments.length === 0 ? (
            <Card className="border-0 shadow-sm">
              <CardContent className="p-12 text-center">
                <FileText className="w-16 h-16 text-slate-200 mx-auto mb-4" />
                <p className="text-slate-500">
                  Você ainda não tem desenvolvimentos.<br />
                  Explore o catálogo e solicite sua personalização!
                </p>
              </CardContent>
            </Card>
          ) : (
            developments.map(dev => renderDevelopmentCard(dev, true, false, true))
          )}
        </TabsContent>

        <TabsContent value="pending" className="mt-6 space-y-4">
          {awaitingApproval.length === 0 ? (
            <Card className="border-0 shadow-sm">
              <CardContent className="p-8 text-center">
                <Eye className="w-12 h-12 text-slate-200 mx-auto mb-3" />
                <p className="text-slate-500">Nenhum desenvolvimento aguardando aprovação</p>
              </CardContent>
            </Card>
          ) : (
            awaitingApproval.map(dev => renderDevelopmentCard(dev, true, false, true))
          )}
        </TabsContent>

        <TabsContent value="approved" className="mt-6 space-y-4">
          {/* Search and Filter */}
          <div className="relative">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
            <Input
              placeholder="Buscar por nome do produto ou código..."
              value={approvedSearch}
              onChange={(e) => setApprovedSearch(e.target.value)}
              className="pl-9"
            />
          </div>

          {approvedDevelopments.filter(d => d.status === 'approved').length > 0 && (
            <div className="flex items-center justify-between p-4 bg-emerald-50 rounded-xl">
              <div>
                <p className="font-medium text-emerald-900">
                  {selectedForOrder.length > 0 
                    ? `${selectedForOrder.length} item(s) selecionado(s)`
                    : 'Selecione itens para emitir novo pedido'}
                </p>
                <p className="text-sm text-emerald-700">
                  Clique nos cards para selecionar
                </p>
              </div>
              <Button
                disabled={selectedForOrder.length === 0 || createOrder.isPending}
                onClick={() => setShowOrderModal(true)}
                className="bg-emerald-600 hover:bg-emerald-700"
              >
                {createOrder.isPending ? (
                  <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                ) : (
                  <ShoppingCart className="w-4 h-4 mr-2" />
                )}
                Emitir Pedido
              </Button>
            </div>
          )}

          {approvedDevelopments.length === 0 ? (
            <Card className="border-0 shadow-sm">
              <CardContent className="p-8 text-center">
                <CheckCircle2 className="w-12 h-12 text-slate-200 mx-auto mb-3" />
                <p className="text-slate-500">Nenhum desenvolvimento aprovado</p>
              </CardContent>
            </Card>
          ) : (
            approvedDevelopments
              .filter(dev => {
                if (!approvedSearch.trim()) return true;
                const search = approvedSearch.toLowerCase();
                return dev.product_name?.toLowerCase().includes(search) ||
                       dev.request_number?.toLowerCase().includes(search);
              })
              .map(dev => renderDevelopmentCard(dev, false, dev.status === 'approved', true))
          )}
        </TabsContent>
      </Tabs>

      {/* Detail Modal */}
      <Dialog open={showDetailModal} onOpenChange={setShowDetailModal}>
        <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>Detalhes do Desenvolvimento</DialogTitle>
          </DialogHeader>

          {selectedDev && (
            <div className="space-y-6">
              {/* Header */}
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-mono text-slate-500">{selectedDev.reference_code || selectedDev.request_number}</p>
                  <h3 className="text-xl font-semibold text-slate-900">{selectedDev.product_name}</h3>
                </div>
                <Badge className={statusConfig[selectedDev.status]?.color}>
                  {statusConfig[selectedDev.status]?.label}
                </Badge>
              </div>

              {/* Info Grid */}
              <div className="grid grid-cols-2 gap-4">
                <div className="p-4 bg-slate-50 rounded-xl">
                  <p className="text-sm text-slate-500">Quantidade</p>
                  <p className="text-lg font-semibold">{selectedDev.quantity} unidades</p>
                  <p className="text-xs text-slate-400">Mín: {selectedDev.min_order_quantity || 100}</p>
                </div>
                <div className="p-4 bg-slate-50 rounded-xl">
                  <p className="text-sm text-slate-500">Preço Base</p>
                  <p className="text-lg font-semibold">R$ {selectedDev.product_base_price?.toFixed(2) || '0,00'}</p>
                </div>
                {selectedDev.estimated_delivery_date && (
                  <div className="p-4 bg-blue-50 rounded-xl">
                    <p className="text-sm text-blue-600">Previsão de Entrega</p>
                    <p className="text-lg font-semibold text-blue-900">
                      {format(new Date(selectedDev.estimated_delivery_date), "dd 'de' MMMM", { locale: ptBR })}
                    </p>
                  </div>
                )}
                {selectedDev.total_price && (
                  <div className="p-4 bg-emerald-50 rounded-xl">
                    <p className="text-sm text-emerald-600">Valor Total</p>
                    <p className="text-lg font-bold text-emerald-700">R$ {selectedDev.total_price.toFixed(2)}</p>
                  </div>
                )}
              </div>

              {/* Selected Processes */}
              {selectedDev.selected_processes?.length > 0 && (
                <div className="space-y-2">
                  <h4 className="font-semibold text-slate-900 flex items-center gap-2">
                    <Settings className="w-4 h-4 text-violet-500" />
                    Processos Selecionados
                  </h4>
                  <div className="flex flex-wrap gap-2">
                    {selectedDev.selected_processes.map((proc, idx) => (
                      <Badge key={idx} className="bg-violet-100 text-violet-700">
                        {proc.process_name}
                      </Badge>
                    ))}
                  </div>
                </div>
              )}

              {/* Selected Materials with Colors */}
              {selectedDev.selected_materials?.length > 0 && (
                <div className="space-y-2">
                  <h4 className="font-semibold text-slate-900 flex items-center gap-2">
                    <Palette className="w-4 h-4 text-amber-500" />
                    Materiais e Cores
                  </h4>
                  <div className="space-y-2">
                    {selectedDev.selected_materials.map((mat, idx) => (
                      <div key={idx} className="flex items-center gap-3 p-3 bg-amber-50 rounded-lg">
                        <span className="font-medium">{mat.display_name || mat.material_name}</span>
                        {mat.selected_color && (
                          <Badge className="bg-white border">
                            Cor: {mat.selected_color}
                          </Badge>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Description */}
              {selectedDev.description && (
                <div className="space-y-2">
                  <h4 className="font-semibold text-slate-900">Descrição</h4>
                  <p className="text-slate-600 whitespace-pre-wrap">{selectedDev.description}</p>
                </div>
              )}

              {/* Artwork Versions */}
              {artworkVersions.length > 0 && (
                <div className="space-y-3">
                  <h4 className="font-semibold text-slate-900 flex items-center gap-2">
                    <History className="w-4 h-4 text-violet-500" />
                    Artes Desenvolvidas
                  </h4>
                  
                  {/* Main Image - Latest Version */}
                  {(() => {
                    const latestVersion = artworkVersions[0]; // Already sorted by -version_number
                    return (
                      <div className="space-y-2">
                        <div className="flex items-center justify-between">
                          <span className="text-sm font-medium text-violet-700">Versão Atual (v{latestVersion.version_number})</span>
                          <Badge className={
                            latestVersion.status === 'approved' ? 'bg-emerald-100 text-emerald-700' :
                            latestVersion.status === 'rejected' ? 'bg-red-100 text-red-700' :
                            'bg-violet-100 text-violet-700'
                          }>
                            {latestVersion.status === 'approved' ? 'Aprovada' :
                             latestVersion.status === 'rejected' ? 'Rejeitada' : 'Pendente'}
                          </Badge>
                        </div>
                        <div 
                          onClick={() => setZoomedImage(latestVersion.file_url)}
                          className="aspect-video rounded-xl overflow-hidden border-2 border-violet-200 bg-white cursor-pointer relative group"
                        >
                          <img src={latestVersion.file_url} alt="" className="w-full h-full object-contain p-2" />
                          <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                            <ZoomIn className="w-8 h-8 text-white" />
                          </div>
                        </div>
                      </div>
                    );
                  })()}

                  {/* Previous Versions - Thumbnails */}
                  {artworkVersions.length > 1 && (
                    <div className="space-y-2 pt-3 border-t">
                      <span className="text-sm text-slate-500">Versões anteriores</span>
                      <div className="flex gap-2 overflow-x-auto pb-2">
                        {artworkVersions.slice(1).map((version) => (
                          <div 
                            key={version.id}
                            onClick={() => setZoomedImage(version.file_url)}
                            className="relative flex-shrink-0 w-24 h-24 rounded-lg overflow-hidden border bg-white cursor-pointer group"
                          >
                            <img src={version.file_url} alt="" className="w-full h-full object-contain p-1" />
                            {/* Superseded/Substituted overlay */}
                            <div className="absolute inset-0 bg-slate-900/60 flex flex-col items-center justify-center">
                              <span className="text-white text-xs font-medium">v{version.version_number}</span>
                              <Badge className="bg-amber-500 text-white border-0 text-[10px] mt-1 px-1.5">
                                Substituída
                              </Badge>
                            </div>
                            <div className="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                              <ZoomIn className="w-4 h-4 text-white" />
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              )}

              {/* Actions for awaiting approval */}
              {selectedDev.status === 'awaiting_approval' && (
                <div className="flex gap-3 pt-4 border-t">
                  <Button 
                    variant="outline"
                    className="flex-1 text-orange-600 border-orange-200 hover:bg-orange-50"
                    onClick={() => {
                      setShowDetailModal(false);
                      handleOpenApproval(selectedDev, 'revision');
                    }}
                  >
                    <MessageSquare className="w-4 h-4 mr-2" />
                    Solicitar Revisão
                  </Button>
                  <Button 
                    className="flex-1 bg-emerald-600 hover:bg-emerald-700"
                    onClick={() => {
                      setShowDetailModal(false);
                      handleOpenApproval(selectedDev, 'approve');
                    }}
                  >
                    <CheckCircle2 className="w-4 h-4 mr-2" />
                    Aprovar
                  </Button>
                </div>
              )}
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* Approval Modal */}
      <Dialog open={showApprovalModal} onOpenChange={setShowApprovalModal}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>
              {actionType === 'approve' ? 'Confirmar Aprovação' : 'Solicitar Revisão'}
            </DialogTitle>
            <DialogDescription>
              {actionType === 'approve' 
                ? 'Ao aprovar, o item ficará disponível para emissão de pedido.'
                : 'Descreva as alterações necessárias.'}
            </DialogDescription>
          </DialogHeader>

          {selectedDev && (
            <div className="space-y-4">
              <div className="p-4 bg-slate-50 rounded-xl">
                <p className="font-medium">{selectedDev.product_name}</p>
                <p className="text-sm text-slate-500">
                  {selectedDev.quantity} unidades
                  {selectedDev.total_price && ` • R$ ${selectedDev.total_price.toFixed(2)}`}
                </p>
              </div>

              {actionType === 'revision' && (
                <div className="space-y-2">
                  <Label>O que precisa ser alterado?</Label>
                  <Textarea
                    value={revisionNotes}
                    onChange={(e) => setRevisionNotes(e.target.value)}
                    placeholder="Descreva as alterações necessárias..."
                    rows={4}
                    required
                  />
                </div>
              )}

              {actionType === 'approve' && (
                <div className="space-y-4">
                  <div className="p-4 bg-emerald-50 rounded-xl">
                    <p className="text-sm text-emerald-800">
                      ✓ Ao aprovar, confirmo que revisei a arte e estou de acordo com o layout desenvolvido.
                    </p>
                  </div>
                  <div 
                    className="flex items-center gap-2 cursor-pointer"
                    onClick={() => setConfirmApproval(!confirmApproval)}
                  >
                    <Checkbox
                      id="confirm-approval"
                      checked={confirmApproval}
                      onCheckedChange={(checked) => setConfirmApproval(checked)}
                    />
                    <label htmlFor="confirm-approval" className="text-sm text-slate-700 cursor-pointer">
                      Li e concordo. A arte aprovada não poderá ser alterada.
                    </label>
                  </div>
                </div>
              )}

              <div className="flex gap-3 pt-4">
                <Button 
                  variant="outline" 
                  className="flex-1"
                  onClick={() => setShowApprovalModal(false)}
                >
                  Cancelar
                </Button>
                <Button 
                  className={`flex-1 ${actionType === 'approve' ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-orange-600 hover:bg-orange-700'}`}
                  onClick={actionType === 'approve' ? handleApprove : handleRequestRevision}
                  disabled={updateDev.isPending || (actionType === 'revision' && !revisionNotes.trim()) || (actionType === 'approve' && !confirmApproval)}
                >
                  {updateDev.isPending ? (
                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                  ) : actionType === 'approve' ? (
                    <CheckCircle2 className="w-4 h-4 mr-2" />
                  ) : (
                    <MessageSquare className="w-4 h-4 mr-2" />
                  )}
                  {actionType === 'approve' ? 'Aprovar' : 'Enviar Revisão'}
                </Button>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* Image Zoom Modal */}
      <Dialog open={!!zoomedImage} onOpenChange={() => setZoomedImage(null)}>
        <DialogContent className="max-w-4xl p-2">
          <button 
            onClick={() => setZoomedImage(null)}
            className="absolute top-3 right-3 p-2 bg-white rounded-full shadow-lg hover:bg-slate-100 z-10"
          >
            <X className="w-5 h-5" />
          </button>
          {zoomedImage && (
            <div className="w-full flex items-center justify-center bg-slate-50 rounded-xl p-4">
              <img 
                src={zoomedImage} 
                alt="Arte ampliada" 
                className="max-w-full max-h-[80vh] object-contain"
              />
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* Order Confirmation Modal */}
      <Dialog open={showOrderModal} onOpenChange={setShowOrderModal}>
        <DialogContent className="max-w-lg max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>Confirmar Pedido</DialogTitle>
            <DialogDescription>
              Selecione a forma de pagamento e endereço de entrega
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-5">
            {/* Items */}
            <div className="space-y-2">
              <Label className="text-sm text-slate-500">Itens do Pedido</Label>
              {developments
                .filter(d => selectedForOrder.includes(d.id))
                .map(dev => (
                  <div key={dev.id} className="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                    <div>
                      <p className="font-medium">{dev.product_name}</p>
                      <p className="text-sm text-slate-500">{dev.quantity} un.</p>
                    </div>
                    <span className="font-bold">
                      R$ {((dev.unit_price || 0) * dev.quantity).toFixed(2)}
                    </span>
                  </div>
                ))}
            </div>

            {/* Payment Method */}
            <div className="space-y-3">
              <Label className="flex items-center gap-2">
                <CreditCard className="w-4 h-4 text-violet-500" />
                Forma de Pagamento
              </Label>
              <RadioGroup value={paymentMethod} onValueChange={setPaymentMethod} className="grid grid-cols-2 gap-2">
                <div className={`flex items-center gap-2 p-3 rounded-lg border cursor-pointer ${paymentMethod === 'pix' ? 'border-violet-500 bg-violet-50' : 'border-slate-200'}`} onClick={() => setPaymentMethod('pix')}>
                  <RadioGroupItem value="pix" id="pix" />
                  <Label htmlFor="pix" className="cursor-pointer">PIX</Label>
                </div>
                <div className={`flex items-center gap-2 p-3 rounded-lg border cursor-pointer ${paymentMethod === 'boleto' ? 'border-violet-500 bg-violet-50' : 'border-slate-200'}`} onClick={() => setPaymentMethod('boleto')}>
                  <RadioGroupItem value="boleto" id="boleto" />
                  <Label htmlFor="boleto" className="cursor-pointer">Boleto</Label>
                </div>
                <div className={`flex items-center gap-2 p-3 rounded-lg border cursor-pointer ${paymentMethod === 'credit_card' ? 'border-violet-500 bg-violet-50' : 'border-slate-200'}`} onClick={() => setPaymentMethod('credit_card')}>
                  <RadioGroupItem value="credit_card" id="credit_card" />
                  <Label htmlFor="credit_card" className="cursor-pointer">Cartão</Label>
                </div>
                <div className={`flex items-center gap-2 p-3 rounded-lg border cursor-pointer ${paymentMethod === 'transfer' ? 'border-violet-500 bg-violet-50' : 'border-slate-200'}`} onClick={() => setPaymentMethod('transfer')}>
                  <RadioGroupItem value="transfer" id="transfer" />
                  <Label htmlFor="transfer" className="cursor-pointer">Transferência</Label>
                </div>
              </RadioGroup>
            </div>

            {/* Shipping Address */}
            <div className="space-y-3">
              <Label className="flex items-center gap-2">
                <MapPin className="w-4 h-4 text-emerald-500" />
                Endereço de Entrega
              </Label>
              <RadioGroup value={addressType} onValueChange={setAddressType} className="space-y-2">
                {customerData?.address && (
                  <div 
                    className={`p-3 rounded-lg border cursor-pointer ${addressType === 'customer' ? 'border-emerald-500 bg-emerald-50' : 'border-slate-200'}`}
                    onClick={() => setAddressType('customer')}
                  >
                    <div className="flex items-center gap-2 mb-1">
                      <RadioGroupItem value="customer" id="customer-address" />
                      <Label htmlFor="customer-address" className="cursor-pointer font-medium">Endereço cadastrado</Label>
                    </div>
                    <p className="text-sm text-slate-600 ml-6">
                      {customerData.address.street}, {customerData.address.number}
                      {customerData.address.complement && ` - ${customerData.address.complement}`}<br />
                      {customerData.address.neighborhood} - {customerData.address.city}/{customerData.address.state}<br />
                      CEP: {customerData.address.zipcode}
                    </p>
                  </div>
                )}
                <div 
                  className={`p-3 rounded-lg border cursor-pointer ${addressType === 'custom' ? 'border-emerald-500 bg-emerald-50' : 'border-slate-200'}`}
                  onClick={() => setAddressType('custom')}
                >
                  <div className="flex items-center gap-2">
                    <RadioGroupItem value="custom" id="custom-address" />
                    <Label htmlFor="custom-address" className="cursor-pointer font-medium flex items-center gap-1">
                      <Plus className="w-4 h-4" /> Outro endereço
                    </Label>
                  </div>
                </div>
              </RadioGroup>

              {addressType === 'custom' && (
                <div className="space-y-3 pt-2 pl-4 border-l-2 border-emerald-200">
                  <div className="grid grid-cols-3 gap-2">
                    <div className="col-span-2">
                      <Label className="text-xs">Rua</Label>
                      <Input
                        value={customAddress.street}
                        onChange={(e) => setCustomAddress({ ...customAddress, street: e.target.value })}
                        placeholder="Rua/Avenida"
                      />
                    </div>
                    <div>
                      <Label className="text-xs">Número</Label>
                      <Input
                        value={customAddress.number}
                        onChange={(e) => setCustomAddress({ ...customAddress, number: e.target.value })}
                        placeholder="Nº"
                      />
                    </div>
                  </div>
                  <div className="grid grid-cols-2 gap-2">
                    <div>
                      <Label className="text-xs">Complemento</Label>
                      <Input
                        value={customAddress.complement}
                        onChange={(e) => setCustomAddress({ ...customAddress, complement: e.target.value })}
                        placeholder="Apto, Sala..."
                      />
                    </div>
                    <div>
                      <Label className="text-xs">Bairro</Label>
                      <Input
                        value={customAddress.neighborhood}
                        onChange={(e) => setCustomAddress({ ...customAddress, neighborhood: e.target.value })}
                        placeholder="Bairro"
                      />
                    </div>
                  </div>
                  <div className="grid grid-cols-3 gap-2">
                    <div className="col-span-1">
                      <Label className="text-xs">CEP</Label>
                      <Input
                        value={customAddress.zipcode}
                        onChange={(e) => setCustomAddress({ ...customAddress, zipcode: e.target.value })}
                        placeholder="00000-000"
                      />
                    </div>
                    <div>
                      <Label className="text-xs">Cidade</Label>
                      <Input
                        value={customAddress.city}
                        onChange={(e) => setCustomAddress({ ...customAddress, city: e.target.value })}
                        placeholder="Cidade"
                      />
                    </div>
                    <div>
                      <Label className="text-xs">Estado</Label>
                      <Input
                        value={customAddress.state}
                        onChange={(e) => setCustomAddress({ ...customAddress, state: e.target.value })}
                        placeholder="UF"
                        maxLength={2}
                      />
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* Total */}
            <div className="p-4 bg-emerald-50 rounded-xl">
              <div className="flex items-center justify-between">
                <span className="font-medium text-emerald-900">Total do Pedido</span>
                <span className="text-xl font-bold text-emerald-700">
                  R$ {developments
                    .filter(d => selectedForOrder.includes(d.id))
                    .reduce((sum, d) => sum + ((d.unit_price || 0) * d.quantity), 0)
                    .toFixed(2)}
                </span>
              </div>
            </div>

            <div className="flex gap-3 pt-4">
              <Button 
                variant="outline" 
                className="flex-1"
                onClick={() => setShowOrderModal(false)}
              >
                Cancelar
              </Button>
              <Button 
                className="flex-1 bg-emerald-600 hover:bg-emerald-700"
                onClick={() => {
                  const address = addressType === 'customer' ? customerData?.address : customAddress;
                  createOrder.mutate({ 
                    devIds: selectedForOrder, 
                    payment: paymentMethod, 
                    address 
                  });
                }}
                disabled={createOrder.isPending || (addressType === 'custom' && (!customAddress.street || !customAddress.city))}
              >
                {createOrder.isPending ? (
                  <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                ) : (
                  <ShoppingCart className="w-4 h-4 mr-2" />
                )}
                Confirmar Pedido
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>
    </div>
  );
}